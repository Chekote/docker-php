#!/usr/bin/env bash

set -euo pipefail;

ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

. "$ROOT"/bin/lib/colors.sh
. "$ROOT"/bin/lib/log.sh
. "$ROOT"/bin/lib/out.sh

REPO=chekote/php

PATCH_VERSION=
TOKEN=

#######################################
# Grabs a token from auth.docker.com for use with the Docker API V2
#
# Globals:
#   TOKEN
# Return:
#  0 if the auth succeed. 1 if not.
#######################################
dockerAuth() {
  local RESPONSE
  RESPONSE="$(curl 'https://auth.docker.io/token?service=registry.docker.io&scope=repository:'chekote/php':pull' 2>/dev/null)"
  TOKEN=$(echo "$RESPONSE" | jq -r .token)

  if [ "$TOKEN" == null ]; then
    out.error "Docker login failed: $RESPONSE"
    return 1
  fi

  return 0
}

#######################################
# Provides the latest tag that has been published for the specified tag and suffix
#
# Will check if "$REPO:$TAG$SUFFIX" is available first, followed by "$REPO:$TAG-{a..z}$SUFFIX". The last tag that
# exists will be echoed to stdout. If the tag does not exist, then an empty string will be echoed to stdout.
#
# Arguments:
#   1 the tag, e.g. 5.3.6
#   2 the tag suffix, e.g. -phpunit6
#######################################
latestTag() {
  local TAG="$1"
  local SUFFIX="$2"
  local LATEST_TAG

  log.info "Checking if $TAG$SUFFIX exists"
  if ! tagExists "$TAG$SUFFIX"; then
    log.info "Tag $TAG$SUFFIX does not exist"
    log.info "There is no latest tag"
    echo ""
    return 0
  else
    log.info "Tag $TAG$SUFFIX exists"
  fi

  LATEST_TAG="$TAG$SUFFIX"
  log.info "latestTag::LATEST_TAG is now $LATEST_TAG"
  for X in {a..z}; do
    NEXT_TAG="$TAG.$X$SUFFIX"
    if tagExists "$NEXT_TAG"; then
      log.info "Tag $NEXT_TAG exists"
      LATEST_TAG="$NEXT_TAG"
      log.info "latestTag::LATEST_TAG is now $LATEST_TAG"
    else
      log.info "Tag $NEXT_TAG does not exist"
      log.info "$LATEST_TAG is the latest tag"
      break
    fi
  done

  log.info "returning $LATEST_TAG"
  echo "$LATEST_TAG"
}

#######################################
# Determines the next available tag for the specified tag and suffix
#
# Will check if "$REPO:$TAG$SUFFIX" is available first, and if not will check"$REPO:$TAG-{a..z}$SUFFIX".
# If an available tag is found, it will be echoed to stdout
#
# Arguments:
#   1 the tag, e.g. 5.3.6
#   2 the tag suffix, e.g. -phpunit6
# Returns:
#   0 if a next available tag was found. 1 if no tags are available.
#######################################
nextAvailableTag() {
  local TAG="$1"
  local SUFFIX="$2"
  local NEXT_TAG

  if ! tagExists "$TAG$SUFFIX"; then
    echo "$TAG$SUFFIX"
    return 0
  fi

  for X in {a..z}; do
    NEXT_TAG="$TAG.$X$SUFFIX"
    if ! tagExists "$NEXT_TAG"; then
      echo "$NEXT_TAG"
      return 0
    fi
  done

  echo "No available tags for $TAG$SUFFIX"
  return 1
}

#######################################
# Checks if the specified tag exists in the chekote/php repo
#
# Arguments:
#  1 the tag
# Return:
#  0 if the tag exists, 1 if not (or an error occurred).
#######################################
tagExists() {
  log.info "Checking for existence of tag $1"
  curl -s -H "Authorization: Bearer $TOKEN" https://index.docker.io/v2/chekote/php/tags/list | jq -r .tags | grep "\"$1\"" > /dev/null 2>&1
}

#######################################
# Gets the SHA for a tag
#
# Arguments:
#  1 the tag
#######################################
tagSHA() {
  log.info "Getting SHA for tag $1"
  curl -s -H "Authorization: Bearer $TOKEN" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
      "https://index.docker.io/v2/chekote/php/manifests/$1" | jq -r .config.digest | cut -d':' -f 2
}

#######################################
# Gets the patch tag for the image being built
#
# Arguments:
#  1 the tag
#  1 the tag suffix
#  1 the SHA of the image
# Returns:
#   0 if a patch tag could be determined. 1 if no tags are available.
#######################################
patchTag() {
  local TAG="$1"
  local SUFFIX="$2"
  local SHA="$3"
  local LATEST_TAG=''

  log.info "Checking if $TAG$SUFFIX exists"
  if ! tagExists "$TAG$SUFFIX"; then
    log.info "Tag $TAG$SUFFIX does not exist"
    echo "$TAG$SUFFIX"
    return 0
  else
    log.info "Tag $TAG$SUFFIX exists"
  fi

  log.info "patchTag::LATEST_TAG before: '$LATEST_TAG'"
  LATEST_TAG=$(latestTag "$TAG" "$SUFFIX")
  log.info "patchTag::LATEST_TAG after: '$LATEST_TAG'"

  LATEST_TAG_SHA=$(tagSHA "$LATEST_TAG");
  log.info "Latest Tag ($LATEST_TAG) SHA: $LATEST_TAG_SHA"
  log.info "New SHA: $SHA"

  if [ "$LATEST_TAG_SHA" = "$SHA" ]; then
    echo "$LATEST_TAG"
    return 0
  fi

  nextAvailableTag "$TAG" "$SUFFIX"
}

#######################################
# Checks that the PHP version being built is between the two specified versions (inclusive)
#
# Arguments:
#  1 the lowest version of the range to check
#  2 the highest version of the range to check
# Return:
#  0 if the version being build is between the two specified versions. 1 if not.
#######################################
versionBetween() {
  local FULL_VERSION="$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION"
  if versionLessThan "$FULL_VERSION" "$1"; then
    return 1;
  fi

  if versionGreaterThan "$FULL_VERSION" "$2"; then
    return 1;
  fi

  return 0;
}

#######################################
# Checks two PHP versions to determine if the 1st is greater than the 2nd
#
# Arguments:
#  1 the 1st version to compare
#  2 the 2nd version to compare
# Globals:
#  REPO  the name of Docker Hub repo where the images are hosted
# Return:
#  0 if the 1st version is greater than the 2nd. 1 if not.
#######################################
versionGreaterThan() {
  docker container run --rm "$REPO:7" php -r "version_compare('$1', '$2', '>') ? exit(0) : exit(1);";
  return $?
}

#######################################
# Checks two PHP versions to determine if the 1st is less than the 2nd
#
# Arguments:
#  1 the 1st version to compare
#  2 the 2nd version to compare
# Return:
#  0 if the 1st version is less than the 2nd. 1 if not.
#######################################
versionLessThan() {
  docker container run --rm "$REPO:7" php -r "version_compare('$1', '$2', '<') ? exit(0) : exit(1);";
  return $?
}

#######################################
# Asserts that PHP version being built equal to or higher than the specified version
#
# Arguments:
#  1 the version to assert
#######################################
assertVersionAtLeast() {
  local FULL_VERSION="$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION"
  if versionLessThan "$FULL_VERSION" "$1"; then
    out.warn "No further images supported for PHP version $FULL_VERSION. Quitting..."
    exit 0
  fi
}

#######################################
# Builds and pushes all of the PHP images for the current major and minor version
#
# Arguments:
#  1 the image to build. Must have a matching .docker file in the root of the project.
# Globals:
#   IMAGE         the name of the image currently being build
#   REPO          the name of Docker Hub repo where the images are hosted
#   MAJOR_VERSION the major PHP version to build images for
#   MINOR_VERSION the minor PHP version to build images for
#   PATCH_VERSION the patch PHP version that was built
#######################################
buildImage() {
  IMAGE="$1"
  local TAG_SUFFIX
  local PATCH_TAG
  local SHA

  TAG_SUFFIX=$([[ "$IMAGE" == "php" ]] && echo "" || echo "-$IMAGE")

  local MAJOR_TAG="$MAJOR_VERSION$TAG_SUFFIX"
  local MINOR_TAG="$MAJOR_VERSION.$MINOR_VERSION$TAG_SUFFIX"

  buildMultiArchImage "$IMAGE" "$REPO:$MAJOR_TAG"

  log.info "Pulling multi-arch image '$REPO:$MAJOR_TAG' since buildx does not support loading currently..."
  docker image pull "$REPO:$MAJOR_TAG"

  if [ "$IMAGE" = "php" ]; then
    PATCH_VERSION=$(docker run --rm "$REPO:$MAJOR_VERSION" php -r '
        $version = ($dashPos = strpos(PHP_VERSION, "-")) === false ? PHP_VERSION : substr(PHP_VERSION, 0, $dashPos);
        echo explode(".", $version)[2];
    ')
    log.info "PHP Patch Version: $PATCH_VERSION"
  fi

  SHA=$(docker image inspect "$REPO:$MAJOR_TAG" | jq -r '.[0].Id' | cut -d':' -f 2);

  log.info "Determining Patch Tag"
  PATCH_TAG=$(patchTag "$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION" "$TAG_SUFFIX" "$SHA")
  log.info "Patch Tag: $PATCH_TAG"

  buildMultiArchImage "$IMAGE" "$REPO:$MINOR_TAG"
  buildMultiArchImage "$IMAGE" "$REPO:$PATCH_TAG"
}

#######################################
# Builds and pushes a multi-arch image
#
# Ideally this should just build and not push, but buildx does not currently support loading.
#
# Arguments:
#   1 the image to build. Must have a matching .docker file in the root of the project.
#   2 the tag to use for the image
# Globals:
#   MAJOR_VERSION the major PHP version to build images for
#   MINOR_VERSION the minor PHP version to build images for
#######################################
buildMultiArchImage() {
    local IMAGE="$1"
    local TAG="$2"

    out.info ""
    out.info "Building $1 multi-arch image with tag '$2'"
    docker buildx build --push --platform linux/arm/v7,linux/arm64/v8,linux/amd64 -f "$1.docker" \
        --build-arg PHP_VERSION="$MAJOR_VERSION.$MINOR_VERSION" -t "$TAG" . > "logs/$1.log" 2>&1
    out.success "Successfully built & pushed multi-arch image with tag '$TAG'"
}

#######################################
# Tags the specified image
#
# Arguments
#  1 the image to tag
#  2 the tag to use
#######################################
tagImage() {
  docker image tag "$1" "$2"
  out.success "Successfully tagged $2"
}

#######################################
# Builds all images
#######################################
buildAll() {
  buildImage php

  # requires 5.3.2
  assertVersionAtLeast 5.3.2
  buildImage composer

  # requires 5.3.3
  assertVersionAtLeast 5.3.3
  buildImage behat3.4
  buildImage behat3.4-sqlite

  # requires 7.2.0
  assertVersionAtLeast 7.2.0
  buildImage phpunit8

  #requires 7.2.5
  assertVersionAtLeast 7.2.5
  buildImage laravel7.x

  #requires 7.3
  assertVersionAtLeast 7.3
  buildImage laravel8.x
  buildImage phpunit9

  #requires 8.0
  assertVersionAtLeast 8.0
  buildImage laravel9.x

  #requires 8.1
  assertVersionAtLeast 8.1
  buildImage laravel10.x
  buildImage phpunit10
}

dockerAuth

out.info "Please enter the major PHP version (e.g. 5, 7), followed by [ENTER]:"
read MAJOR_VERSION

out.info ""
out.info "Please enter the minor PHP version (e.g. 1, 2, 3), followed by [ENTER]:"
read MINOR_VERSION

buildAll
